# 日本語文章Lint Webエディタ（MVP） 要件定義

## 背景・狙い（Why）
- 技術記事やドキュメントにおいて、「内容レビュー以前の指摘」が多発している
  - 文法・表記揺れ・冗長表現など、最低限の品質管理が作者に委ねられている
  - レビュー工数が膨らみ、本来確認すべき内容・正確性への集中を阻害する
- レビュー前段で自動的に品質を底上げできる環境が必要

結論：
「レビューに回す前に、最低品質ラインを自動で突破させる」  
ことが本製品の狙いである。

---

## 現状の課題（既存UIの問題点）
textlint Playground（公式UI）の課題：
- 編集画面にポップアップが重なり可読性を損なう
- 指摘内容を理解するにはカーソル操作が必要で手間
- 一画面に全情報を詰め込み、情報構造が破綻
- 文章全体の俯瞰がしづらい
- あくまで“サンプル実装”であり、実用性が不足

問題を要約すると：
> 「書く行為」と「指摘内容を確認する行為」が同じ場所で衝突し、ユーザが迷子になる

---

## 解決したいこと（価値提供）
- Webブラウザだけで textlint を動かせる
- どこが間違っているか瞬時に把握できる
- 指摘箇所へジャンプできて、直す行為に迷わない
- 設定を意識せずに使える
- 非エンジニアでも理解できる操作性

---

## 製品コンセプト
> 「問題を見つける面」と  
> 「問題を直す面」を完全に分離した文章品質保証ツール

翻訳アプリの操作直感 × textlint の品質ゲート  
「文章をより読みやすく“調整する” Webエディタ」

- 左：入力エディタ（編集に集中）
- 右：指摘ナビパネル（問題一覧と詳細）

---

## UI モック（MVP設計の中心）

```
┌──────────────────────────────────────────────────────────────┐
│ プリセット: 技術記事 [▼]              Lint実行 [手動] [自動OFF] │
└──────────────────────────────────────────────────────────────┘

┌───────────────────────────────┬───────────────────────────────┐
│ 左：入力エディタ                                                 │  右：指摘パネル                     │
│───────────────────────────────│───────────────────────────────│
│  …文章を編集…                                                     │  ▼ 指摘リスト                      │
│  該当箇所に赤波線等のハイライト                                 │  ┌─────────────────────────────┐   │
│                                                                   │  │ 行124: 一つの文で"、"を4つ以上 │   │
│                                                                   │  │        使用しています           │   │
│                                                                   │  │        (max-ten)               │   │
│                                                                   │  └─────────────────────────────┘   │
│                                                                   │                                   │
│                                                                   │  ▼ 選択中の指摘詳細                │
│                                                                   │  ┌─────────────────────────────┐   │
│                                                                   │  │ 行: 124                      │   │
│                                                                   │  │ ルール: ja-technical-writing │   │
│                                                                   │  │         /max-ten             │   │
│                                                                   │  │ 対象文:                      │   │
│                                                                   │  │   Serena はSkillディレクトリ…│   │
│                                                                   │  └─────────────────────────────┘   │
│                                                                   │                                   │
│  ※ 右の指摘をクリック = 左が該当行へスクロールし強調             │                                   │
└───────────────────────────────┴───────────────────────────────┘
```

情報動線：
1. 右で問題を把握する →  
2. クリックで左へジャンプ →  
3. 左で修正 →  
4. 右で確認

ユーザーが迷わないワークフローに寄せる。

---

## 基本機能（MVP）
| 分類 | 内容 |
|------|------|
| Lint機能 | textlint をブラウザ（Web Worker）で実行 |
| 表示 | 指摘一覧パネル、対象文のハイライト |
| 編集操作 | エディタ内文字編集のみ（1画面） |
| ナビゲーション | 指摘→行へのジャンプ |
| 実行方式 | 手動Lintが基本。自動は後述の制限付き |
| セキュリティ | 全処理ローカル完結 |

---

## 実行モード（初期仕様）
- 手動Lint（ボタン押下）
- 自動Lintは負荷・操作性配慮の観点から以下で制御
  - 自動Fixは行わない（カーソル飛び防止）
  - 具体的な挙動は「自動Lintの挙動」で定義する

---

## 設定の扱い
| 層 | 存在 | 露出レベル |
|---|---|---|
| 一般ユーザー | 用途プリセットのみ変更可能 | 画面に見せる |
| 開発者・管理者 | ルールセット（JSON/YAML編集） | UI非表示、ビルド反映 |

用途プリセット：
- MVPは 技術記事 の1つに絞る  
  （他プリセットは将来検討）

---

## 例外操作（最小限）
- 特定指摘の「無視」機能
  - ルール単位の切替は UI に出さない
  - 個別インスタンス単位で無視

---

## MVPで含めない（範囲明確化）
- 履歴管理・差分保存
- チーム運用機能（承認フロー等）
- 文章校正AI（修正提案生成）
- 右ペインでの修正適用（Fix）

---

## 検討したがMVPに含めないUI要素（申し送り）

### 修正ヒント表示
- 文脈依存の修正提案は自動化が難しい
- 期待値が生成AI相当に膨らむリスク
- ルール運用コストが高い

将来選択肢として：
- 各ルールの静的ガイド文
- LLM支援（コスト・品質次第）

※「検討はしたが、当面は採用しない」という明示のために記載

---

## 提供価値（まとめ）
- 誰が書いても最低品質ラインを突破できる
- レビューが本質的な内容に集中できる
- ドキュメント文化の負担を削減
- 日本語文章品質の標準化を後押しする

---

## 成功指標（仮）
- 指摘0でレビューに上がる初稿割合
- レビュー工数削減（主観でも良い）
- 継続利用率

---

## 技術要件

### アーキテクチャ方針

- フレームワークとして Next.js を採用する。
- ランディングページ、プライバシーポリシー、利用規約などの静的ページは、基本的に SSG（Static Site Generation）で生成する。
- 文章Lintエディタ本体は、Next.js 上の「クライアントサイド専用ページ」として実装する。
  - 例: `/lint-editor` ページはクライアントコンポーネント構成とし、サーバー側でのテキスト処理は一切行わない。
- 入力された文章データは、ブラウザ外（サーバー／外部サービス）に送信しないことを原則とする。
  - API Route, Route Handler, Edge Functions 等で文章内容を扱わない。
  - 文章内容を含むログをサーバー側に送信しない。

### textlint の実行方式

- textlint 本体および利用するルール群は、Next.js のフロントエンドバンドルとしてクライアント側に配布する。
- textlint の実行は Web Worker 上で行い、メインスレッド（React のレンダリング・入力処理）とは分離する。
  - メインスレッド: エディタの描画、入力・スクロール、ハイライト表示など UI 処理を担当。
  - Web Worker: エディタ内テキストを受け取り、textlint を実行し、その結果（位置情報・メッセージ）だけをメインスレッドに返す。
- Lint 実行モード:
  - 手動実行モード:
    - ユーザーが「Lint実行」ボタンを押下したタイミングで、最新のテキストを Web Worker に送信し、結果を受け取る。
- 自動修正（fix）について:
  - MVP 段階では、自動実行時にテキストを書き換えない。
  - 必要な場合のみ、ユーザー操作（ボタンなど）で fix を適用する方針とする（詳細仕様は別途検討）。

### プライバシー前提

- 「ブラウザ内で完結すること」を前提とし、文章内容を解析する処理はすべてクライアントサイド（Web Worker 含む）で行う。
- 将来的に生成AI（例: Vertex AI 等）と連携する場合も、現在の「ローカル完結モード」を維持できるよう、モード切り替え設計を前提とする（MVP範囲外）。

### ルールセット管理

- textlint のルール設定（有効／無効、しきい値など）は リポジトリ内の設定ファイルとして管理する。
- ルール設定の変更は、リポジトリを更新しデプロイを行うことで反映する。
- 一般ユーザーがルールを直接変更できる UI は提供しない。
  - MVPでは プリセットは1種類のみ（技術記事用）
  - 将来的に複数プリセットへ拡張できる設計とする
- ルールは「文章品質ガイドライン」の変更として扱い、頻繁に変更しない前提とする。
- 過度に厳しいルールは避け、実用性を優先する（使われなくなるリスクを回避）

### パフォーマンス要件

- textlint は Web Worker 上で実行し、UI のフリーズを防ぐ。
- lint 実行中でも入力・スクロールなどの操作が途切れないこと。
- 初回ロード時のバンドルサイズは、使用するルールを最小限にすることで抑制する。
  - ルールのオン／オフは実行可否のみを制御し、バンドルサイズには影響しない前提とする。
- lint対象テキストが長大（例: 数万文字以上）になる場合の制御を設ける。
  - 必要に応じて警告表示、対象範囲の限定などを検討する。
- PC（一般的なノートPCクラス）での目安として、1万文字・指摘200件程度までのテキストで、入力時に体感できるフリーズや顕著な入力遅延が発生しないこと。
- スマートフォン・タブレットは性能要件の対象外とし、ベストエフォートでの動作とする。
- 自動Lintは負荷・操作性配慮の観点から、「自動Lintの挙動」で定義する仕様に従い、入力遅延を招かないこと。

### セキュリティ／プライバシー要件

- ユーザーが入力した文章内容を、サーバー側や外部サービスへ送信・保存しない。
- Next.js の API Route や Route Handler 等を用いて、文章内容を受け取る処理は実装しない。
- アクセス解析やエラー監視を導入する場合でも、以下を満たすこと。
  - 入力した文章の本文そのものをログやイベントに含めない。
  - 送信してよい情報は、ページ名、ボタン押下回数などの「文章内容と切り離されたメタ情報」に限定する。
- ドラフトはブラウザの localStorage に保存し、同一ブラウザ・同一端末においてのみ復元できるものとする。
- localStorage に保存されたドラフトは、ユーザーの操作（「ドラフトをクリア」）またはブラウザ側のキャッシュ削除によって消去される。セッション終了時に自動削除は行わない。

### ホスティング要件

- ホスティング先は Vercel を前提とする。
- Next.js の利用範囲は以下に限定する。
  - ランディングページ、プライバシーポリシー等の静的ページは SSG で生成・配信する。
  - 文章Lintエディタページはクライアントサイド専用ページとし、サーバー側で文章内容を扱わない。
- バックエンドに依存しなくても動作する構成とし、Vercel 上では「静的ファイル＋クライアントサイド実行」で完結させる。
- インフラ構成は単純化し、Vercel 上の単一プロジェクトとして運用する（追加のサーバーコンポーネントや別バックエンドはMVPでは持たない）。
- Lint 対象となる入力文章はすべてブラウザ内で処理し、ネットワーク送信は行わない。
  - 企業利用を想定したプライバシー要件を満たす。

---

## Lint実行方式

- textlint は Web Worker 内で処理を行う。
- メインスレッドは UI とエディタ操作を担当する。
- クライアントサイドのみで完結させ、文章データは外部送信しない。

### Worker 通信インターフェース

メイン → Worker（Lint依頼）

```ts
{
  type: "lint";
  requestId: string;
  text: string;
}
```

Worker → メイン（Lint結果）

```ts
{
  type: "lint:result";
  requestId: string;
  results: LintResult[];
}
```

### LintResult 型(実際はZodやArkType, ValiBotなどでパースする)

```ts
type LintResult = {
  id: string;                // UI側が参照する一意なID
  ruleId: string;            // textlintのruleId（例: "ja-technical-writing/ja-no-mixed-period"）
  message: string;           // 指摘内容
  line: number;
  column: number;
  startIndex: number;        // UTF-16コード単位ベースのインデックス（JS String.length と同じ）
  endIndex: number;          // UTF-16コード単位ベースのインデックス
  severity: "error" | "warning";
  snippet: string;           // 問題箇所の抜粋
  fixable: boolean;          // fix情報の有無からメイン側で算出
  fixText?: string;          // fix適用後のテキスト（必要に応じて保持）
};
```

- `startIndex` / `endIndex` は、textlint の index と同じく UTF-16 コード単位基準とする  
  （JavaScript の `String.length` / CodeMirror の位置計算と整合させる）

---

### 自動修正（Auto Fix）

- `.fix` が存在する指摘のみ自動修正対象とする。
- ルールIDベースで「安全／危険」を決め打ちしない。  
  → textlint が `fix` を付与したメッセージだけを信頼して適用する。
- 自動修正ボタン押下時の挙動
  - Worker に対して textlint の fix API を用いた処理を依頼する。
  - 戻り値のテキストでエディタ内容を丸ごと更新する。
  - 更新後に再度 lint を実行し、指摘リストとハイライトを再描画する。
- 自動修正可能件数（`fixable: true` の件数）が 1件以上のときのみ
  - 自動修正ボタンを有効化する。

実際に動かしたときの例

```bash
./node_modules/.bin/textlint \
  --format json \
  blog/2025-11-09_i-tried-running-code-using-official.md \
| jq '.[]?
      | .messages[]?
      | select(.ruleId == "ja-technical-writing/ja-no-mixed-period")
      | {ruleId, line, column, hasFix:(.fix != null), fix:.fix}'
{
  "ruleId": "ja-technical-writing/ja-no-mixed-period",
  "line": 116,
  "column": 95,
  "hasFix": false,
  "fix": null
}
```

---

### エディタコンポーネント

- メインエディタには CodeMirror を採用する。
- IME 入力・カーソル位置・選択範囲・差分管理は CodeMirror に委譲する。
- Lint 結果に基づくハイライトは CodeMirror の装飾 API で実装する。
  - エラー箇所の下線・背景色などを付与。
  - 指摘クリック時の強調表示（active 状態）も CodeMirror 側で制御する。
- MVP では実装を単純に保つため、Lint 結果に対しては全件ハイライトを付与する。
- パフォーマンス問題が顕在化した場合は、「画面内およびその前後数十行のみをハイライト対象とする」方式への切り替えを、拡張方針として検討対象とする（申し送り）。

---

### UI 動作

- 右側の指摘リストは LintResult の配列をそのまま表形式・カード形式で表示する。
- 指摘アイテムをクリックした場合
  - 対応する `id` / `startIndex` / `line` に基づき、エディタ内の該当箇所へスクロールする。
  - 対象範囲を一時的に強調表示する。
- 再Lint実行後
  - 選択状態・強調表示はリセットする（MVPでは保持しない）。

---

### テキスト保持ポリシー

- ドラフトは常に 1 本のみ管理する（MVP の範囲）。
- 入力テキストはブラウザの localStorage に全文保存する。
- 保存タイミングは Lint 実行に連動させる（入力デバウンス後に Lint が完了した時点で保存）。
- ページリロード時、localStorage にドラフトがあればその内容をエディタに復元する。
- ユーザー操作で「ドラフトをクリア」でき、その場合は localStorage の該当キーを削除する。
- 差分保存は行わず、常に全文を上書き保存する。
- サーバー側には文章内容を一切保存しない。

---

### 多タブ挙動の扱い

- localStorage は同一オリジンのタブ間で共有されるため、複数タブで同一ページを開いた場合は 最後に保存したタブの内容が有効になる（Last Write Wins）。
- MVPでは、複数タブ同時編集による競合は許容範囲のリスクとして扱う。
- 明示的なタブ間同期や競合解決ロジックは実装しない。

---

### セッションID・複数ドラフト管理（検討事項／申し送り）

- 将来的に「複数の下書き（ドラフト）を管理したい」という要求が出た場合、
  - 各ドラフトに一意な ID（セッションID / DraftID）を付与し、
  - URL（例: `/editor/{id}`）と localStorage のキー構造をその ID に紐づける構成が望ましい。
- その際の保存イメージ：
  - 一覧用: `jlwe:drafts` = `[ { id, title, updatedAt }, ... ]`
  - 本文用: `jlwe:drafts:{id}:text`
- 左側サイドバーに「過去の履歴タブ（ドラフト一覧）」を表示し、クリックで `/editor/{id}` に遷移する UI を想定しておく。
  - サイドバーの中身は `jlwe:drafts` の内容から描画する。
  - ドラフト削除時は `jlwe:drafts` と `jlwe:drafts:{id}:*` を合わせて削除する。
- 現時点の MVP 実装では「ドラフト1本のみ・単一キー保存」とするが、
  - 将来このセッションID方式に移行しやすいよう、localStorage 利用箇所は抽象化（ラップ）しておく。

---

### 画面フロー（MVP 想定）

1. 初回アクセス
   - ユーザーがエディタページ（例: `/lint-editor`）にアクセスする。
   - 初期表示時に localStorage を確認し、ドラフトがあればエディタに復元する。
   - ドラフトが無ければ空のエディタ状態で表示する。

2. 編集と Lint
   - ユーザーはエディタ上で文章を入力・編集する。
   - 入力イベントをデバウンスし、一定時間入力が止まったタイミングで Lint を実行する。
   - Lint 結果を右ペインの指摘一覧に表示する。

3. 保存
   - Lint 結果反映と同タイミングで、エディタ全文を localStorage の単一キー（例: `jlwe:currentDraftText`）に上書き保存する。
   - これにより、ブラウザリロード後も同じブラウザ環境であればドラフトを復元できる。

4. 再訪時
   - ユーザーが再度エディタページにアクセスした場合、localStorage のドラフトを読み込み、エディタに復元する。
   - 将来複数ドラフト管理を行う場合は、画面左側にドラフト一覧タブを表示し、選択されたドラフト ID に応じて本文を切り替える。

5. クリア
   - ユーザーが「ドラフトをクリア」操作を行った場合、localStorage の該当キーを削除し、エディタを初期状態に戻す。

---

### 自動Lintの挙動

- 入力中（キー入力および IME 変換中）は自動Lintを実行しない。
- 入力が停止してから約 1500ms 経過したタイミングで、最新テキストに対して自動Lintを 1 回だけ実行する。
- 未完了の lint 処理がある場合、新しいリクエスト送信時に古いリクエストをキャンセルまたは無視し、常に「最後の入力状態」に対する結果のみを採用する。
